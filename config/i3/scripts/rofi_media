#!/usr/bin/env bash

# Minimal Multi-Player Media Menu for Rofi
DIR="$HOME/.config/i3"
RASI="$DIR/theme/rofi/music.rasi"

# 1. Get List of all active players
mapfile -t players < <(playerctl -l 2>/dev/null)
num_players=${#players[@]}

if [[ $num_players -eq 0 ]]; then
    rofi -theme "$RASI" -e "No active media sources found"
    exit 0
fi

mesg=""
options=""

# 2. Build UI: each player gets row in listview
for i in "${!players[@]}"; do
    p="${players[$i]}"
    title=$(playerctl -p "$p" metadata title 2>/dev/null)
    artist=$(playerctl -p "$p" metadata artist 2>/dev/null)
    status=$(playerctl -p "$p" status 2>/dev/null)
    
    [[ -z "$title" ]] && title="Unknown Track"
    [[ -z "$artist" ]] && artist="${p^}"
    
    # Progress info for message area (simple)
    mesg+="P$((i+1)) <b>$artist</b>: $title\n"
    
    # Icon for Play/Pause
    p_icon="󰐊 Play"
    [[ "$status" == "Playing" ]] && p_icon="󰏤 Pause"
    
    # Only 2 items in buttons description for the listview
    # But since music.rasi is a circle-bubble theme, we use the display text carefully
    # We will make it 1 button per player: the Play/Pause toggle with the Artist name
    options+="$p_icon ($artist)\n"
done

# 3. Show Rofi
# We adjust the theme-str to show elements as vertical list instead of horizontal circles
chosen_idx=$(echo -ne "$options" | rofi -dmenu \
    -p "Media" \
    -mesg "$mesg" \
    -theme "$RASI" \
    -markup-rows \
    -format i \
    -theme-str 'listview { columns: 1; lines: '$num_players'; } element-text { horizontal-align: 0; font: "JetBrains Mono 12"; } element { border-radius: 8px; padding: 10px; }')

[[ -z "$chosen_idx" ]] && exit 0

# 4. Action: Toggle the selected player
target_player="${players[$chosen_idx]}"
playerctl -p "$target_player" play-pause

# Refresh
exec "$0"
