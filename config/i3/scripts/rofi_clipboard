#!/usr/bin/env bash

# Advanced Rofi Clipboard with Visual Tabs, Arrow Nav, File Support & Clear History Tab
CACHE_DIR="/tmp/greenclip"
THEME_MAIN="$HOME/.config/i3/theme/rofi/launcher.rasi"
THEME_MEDIA="$HOME/.config/i3/theme/rofi/media.rasi"
CURRENT_VIEW=${1:-Main}

# Pango markup for visual tabs
case "$CURRENT_VIEW" in
    Main)  TABS="<b><u>  Main  </u></b> |   Media   |   Files   |   Clear  " ;;
    Media) TABS="  Main   | <b><u>  Media  </u></b> |   Files   |   Clear  " ;;
    Files) TABS="  Main   |   Media   | <b><u>  Files  </u></b> |   Clear  " ;;
    Clear) TABS="  Main   |   Media   |   Files   | <b><u>  Clear  </u></b>" ;;
esac

# Function to detect if a line is a file path
is_file_path() {
    local line="$1"
    local clean_path=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' -e "s/^'//" -e "s/'$//" -e 's/^"//' -e 's/"$//')
    [[ "$clean_path" == "~"* ]] && eval_path="${HOME}${clean_path:1}" || eval_path="$clean_path"
    if [[ "$eval_path" == /* ]] && [ -e "$eval_path" ]; then
        echo "$eval_path"
        return 0
    fi
    return 1
}

list_main() {
    greenclip print | while read -r line; do
        if [ -z "$line" ]; then continue; fi
        icon="text-x-generic"
        if [[ "$line" == "image/png"* ]]; then
            hash=$(echo "$line" | grep -oE '\-[0-9]+$')
            [ -f "$CACHE_DIR/$hash.png" ] && icon="$CACHE_DIR/$hash.png" || icon="image-x-generic"
        else
            eval_path=$(is_file_path "$line")
            if [ $? -eq 0 ]; then
                if [ -d "$eval_path" ]; then icon="folder"; else
                    case "${eval_path,,}" in
                        *.mp3|*.flac|*.wav|*.ogg|*.m4a|*.mka) icon="audio-x-generic" ;;
                        *.mp4|*.mkv|*.avi|*.mov|*.webm) icon="video-x-generic" ;;
                        *.png|*.jpg|*.jpeg|*.gif|*.svg|*.webp) icon="$eval_path" ;;
                        *.pdf) icon="application-pdf" ;;
                        *.zip|*.tar.gz|*.7z) icon="package-x-generic" ;;
                        *) icon="text-x-generic" ;;
                    esac
                fi
            fi
        fi
        echo -en "$line\0icon\x1f$icon\n"
    done
}

list_media() {
    greenclip print | while read -r line; do
        if [ -z "$line" ]; then continue; fi
        icon=""
        is_media=false
        if [[ "$line" == "image/png"* ]]; then
            hash=$(echo "$line" | grep -oE '\-[0-9]+$')
            [ -f "$CACHE_DIR/$hash.png" ] && icon="$CACHE_DIR/$hash.png" && is_media=true
        else
            eval_path=$(is_file_path "$line")
            if [ $? -eq 0 ] && [ -f "$eval_path" ]; then
                case "${eval_path,,}" in
                    *.mp3|*.flac|*.wav|*.ogg|*.m4a|*.mka) icon="audio-x-generic"; is_media=true ;;
                    *.mp4|*.mkv|*.avi|*.mov|*.webm) icon="video-x-generic"; is_media=true ;;
                    *.png|*.jpg|*.jpeg|*.gif|*.svg|*.webp) icon="$eval_path"; is_media=true ;;
                esac
            fi
        fi
        if [ "$is_media" = true ]; then
            echo -en "$line\0icon\x1f$icon\n"
        fi
    done
}

list_files() {
    greenclip print | while read -r line; do
        if [ -z "$line" ]; then continue; fi
        eval_path=$(is_file_path "$line")
        if [ $? -eq 0 ]; then
            icon="text-x-generic"
            [ -d "$eval_path" ] && icon="folder" || icon="text-x-generic"
            echo -en "$line\0icon\x1f$icon\n"
        fi
    done
}

list_clear() {
    echo -en "üóëÔ∏è Clear Clipboard History\0icon\x1fedit-clear\n"
    echo -en "üìÇ Clear Archive Folder\0icon\x1ffolder-open\n"
    echo -en "‚ö†Ô∏è Clear Everything\0icon\x1fdialog-warning\n"
}

handle_selection() {
    local sel="$1"
    [ -z "$sel" ] && exit 0
    
    # Check for Clear actions
    if [[ "$sel" == *"Clear Clipboard History"* ]]; then
        pkill -f greenclip
        greenclip clear
        greenclip daemon &
        notify-send "Clipboard" "History cleared!"
        exit 0
    elif [[ "$sel" == *"Clear Archive Folder"* ]]; then
        rm -rf /home/arch/clipboard/*
        notify-send "Clipboard" "Archive cleared!"
        exit 0
    elif [[ "$sel" == *"Clear Everything"* ]]; then
        pkill -f greenclip
        greenclip clear
        greenclip daemon &
        rm -rf /home/arch/clipboard/*
        notify-send "Clipboard" "All data cleared!"
        exit 0
    fi
    
    if [[ "$sel" == "image/png"* ]]; then
        hash=$(echo "$sel" | grep -oE '\-[0-9]+$')
        [ -f "$CACHE_DIR/$hash.png" ] && xclip -selection clipboard -t image/png -i "$CACHE_DIR/$hash.png" &
    else
        # Check if it's a file path
        eval_path=$(is_file_path "$sel")
        if [ $? -eq 0 ]; then
            # Copy as proper file URI (for pasting in file managers)
            echo -e "file://${eval_path}\r" | xclip -selection clipboard -t text/uri-list &
        else
            # Default text copy
            printf "%s" "$sel" | xclip -selection clipboard &
        fi
    fi
}

active_theme="$THEME_MAIN"
[ "$CURRENT_VIEW" == "Media" ] && active_theme="$THEME_MEDIA"

# Launch Rofi
selection=$(list_${CURRENT_VIEW,,} | rofi -dmenu \
    -p "Clipboard" \
    -mesg "$TABS" \
    -i -show-icons \
    -kb-row-down "Down" \
    -kb-row-up "Up" \
    -kb-element-next "" \
    -kb-element-prev "" \
    -kb-custom-1 "Tab" \
    -kb-custom-2 "Shift+Tab" \
    -theme "$active_theme")

ret=$?

# Handle switching
if [ $ret -eq 10 ]; then
    case "$CURRENT_VIEW" in
        Main) exec "$0" Media ;;
        Media) exec "$0" Files ;;
        Files) exec "$0" Clear ;;
        Clear) exec "$0" Main ;;
    esac
elif [ $ret -eq 11 ]; then
    case "$CURRENT_VIEW" in
        Main) exec "$0" Clear ;;
        Clear) exec "$0" Files ;;
        Files) exec "$0" Media ;;
        Media) exec "$0" Main ;;
    esac
fi

handle_selection "$selection"
