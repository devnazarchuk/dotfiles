#!/usr/bin/env bash

# Custom Rofi script to handle greenclip with icons
CACHE_DIR="/tmp/greenclip"

# Function to generate the list of clipboard items with icons for Rofi
generate_list() {
    greenclip print | while read -r line; do
        if [ -z "$line" ]; then continue; fi
        
        icon="text-x-generic"
        
        # 1. Detect greenclip image entries
        if [[ "$line" == "image/png"* ]]; then
            hash=$(echo "$line" | grep -oE '\-[0-9]+$')
            if [ -f "$CACHE_DIR/$hash.png" ]; then
                icon="$CACHE_DIR/$hash.png"
            else
                icon="image-x-generic"
            fi
        else
            # 2. Detect if it's a file path
            clean_path=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' -e "s/^'//" -e "s/'$//" -e 's/^"//' -e 's/"$//')
            
            if [[ "$clean_path" == "~"* ]]; then
                eval_path="${HOME}${clean_path:1}"
            else
                eval_path="$clean_path"
            fi
            
            if [[ "$eval_path" == /* ]] && [ -e "$eval_path" ]; then
                if [ -d "$eval_path" ]; then
                    icon="folder"
                else
                    case "${eval_path,,}" in
                        *.mp3|*.flac|*.wav|*.ogg|*.m4a|*.opus|*.mka) icon="audio-x-generic" ;;
                        *.mp4|*.mkv|*.avi|*.mov|*.webm) icon="video-x-generic" ;;
                        *.png|*.jpg|*.jpeg|*.gif|*.svg|*.webp) icon="$eval_path" ;;
                        *.pdf) icon="application-pdf" ;;
                        *.zip|*.tar.gz|*.tgz|*.rar|*.7z|*.tar) icon="package-x-generic" ;;
                        *.txt|*.md|*.conf|*.ini|*.sh|*.py|*.js|*.json|*.ts|*.tsx|*.css|*.html|*.go|*.rs|*.c|*.h|*.cpp|*.hpp|*.yaml|*.yml|*.toml) icon="text-x-script" ;;
                        *) icon="text-x-generic" ;;
                    esac
                fi
            fi
        fi
        
        # Output icon format for Rofi dmenu
        echo -en "$line\0icon\x1f$icon\n"
    done
}

# Run rofi in dmenu mode - this ensures it closes on selection
selection=$(generate_list | rofi -dmenu -i -p "Clipboard" -show-icons -theme ~/.config/i3/theme/rofi/launcher.rasi)

# Handle selection - paste into clipboard
if [ -n "$selection" ]; then
    if [[ "$selection" == "image/png"* ]]; then
        hash=$(echo "$selection" | grep -oE '\-[0-9]+$')
        if [ -f "$CACHE_DIR/$hash.png" ]; then
            xclip -selection clipboard -t image/png -i "$CACHE_DIR/$hash.png"
            exit 0
        fi
    fi
    printf "%s" "$selection" | xclip -selection clipboard
fi
